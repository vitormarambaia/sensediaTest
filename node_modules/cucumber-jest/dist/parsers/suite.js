"use strict";

var _Object$keys = require("@babel/runtime-corejs3/core-js-stable/object/keys");

var _Object$getOwnPropertySymbols = require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols");

var _filterInstanceProperty = require("@babel/runtime-corejs3/core-js-stable/instance/filter");

var _Object$getOwnPropertyDescriptor = require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor");

var _forEachInstanceProperty = require("@babel/runtime-corejs3/core-js-stable/instance/for-each");

var _Object$getOwnPropertyDescriptors = require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors");

var _Object$defineProperties = require("@babel/runtime-corejs3/core-js-stable/object/define-properties");

var _Object$defineProperty = require("@babel/runtime-corejs3/core-js-stable/object/define-property");

var _interopRequireDefault = require("@babel/runtime-corejs3/helpers/interopRequireDefault");

_Object$defineProperty(exports, "__esModule", {
  value: true
});

exports.parseSuite = parseSuite;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime-corejs3/helpers/defineProperty"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime-corejs3/helpers/toConsumableArray"));

var _slice = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/slice"));

var _some = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/some"));

var _includes = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/includes"));

var _reduce = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/reduce"));

var _concat = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/concat"));

var _map = _interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/map"));

var _fs = _interopRequireDefault(require("fs"));

var _path = _interopRequireDefault(require("path"));

var _generateMessages = _interopRequireDefault(require("@cucumber/gherkin/dist/src/stream/generateMessages"));

var _IdGenerator = require("@cucumber/messages/dist/src/IdGenerator");

var _chalk = _interopRequireDefault(require("chalk"));

var _outdent = _interopRequireDefault(require("outdent"));

var _env = _interopRequireDefault(require("../configs/env"));

var _feature = require("./feature");

var _steps = require("./steps");

var _table = require("./table");

var _tags2 = require("./tags");

function ownKeys(object, enumerableOnly) { var keys = _Object$keys(object); if (_Object$getOwnPropertySymbols) { var symbols = _Object$getOwnPropertySymbols(object); if (enumerableOnly) symbols = _filterInstanceProperty(symbols).call(symbols, function (sym) { return _Object$getOwnPropertyDescriptor(object, sym).enumerable; }); keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { var _context9; _forEachInstanceProperty(_context9 = ownKeys(Object(source), true)).call(_context9, function (key) { (0, _defineProperty2.default)(target, key, source[key]); }); } else if (_Object$getOwnPropertyDescriptors) { _Object$defineProperties(target, _Object$getOwnPropertyDescriptors(source)); } else { var _context10; _forEachInstanceProperty(_context10 = ownKeys(Object(source))).call(_context10, function (key) { _Object$defineProperty(target, key, _Object$getOwnPropertyDescriptor(source, key)); }); } } return target; }

function parseSuite(cwd, feature, extensions, cucumberSupportCode) {
  var _events$, _events$$gherkinDocum, _context;

  const featurePath = (0, _feature.parseFeature)(cwd, feature, extensions);

  const source = _fs.default.readFileSync(featurePath, 'utf8');

  const events = (0, _generateMessages.default)(source, _path.default.normalize(_path.default.relative(cwd, featurePath)), {
    includeSource: false,
    includeGherkinDocument: true,
    includePickles: true,
    newId: (0, _IdGenerator.uuid)()
  });

  if (!((_events$ = events[0]) !== null && _events$ !== void 0 && (_events$$gherkinDocum = _events$.gherkinDocument) !== null && _events$$gherkinDocum !== void 0 && _events$$gherkinDocum.feature)) {
    var _events$2;

    // feature is not defined if an error occurs while parsing
    // and the error is added as an attachment
    const attachment = (_events$2 = events[0]) === null || _events$2 === void 0 ? void 0 : _events$2.attachment;
    throw new Error((0, _outdent.default)`
            ${_chalk.default.red('[error]')} failed to parse feature file:\n
            file: ${_chalk.default.yellow(featurePath)}
            ${attachment ? [`message: ${attachment.text}`, `column: ${attachment.source.location.column}`, `line: ${attachment.source.location.line}`].join('\n') : ''}
            \n
        `);
  }

  const document = events[0].gherkinDocument.feature;
  const hasBackground = !!document.children[0].background;
  const specs = hasBackground ? (0, _slice.default)(_context = document.children).call(_context, 1) : document.children;
  const hasExcludeTags = _env.default.EXCLUDE_TAGS.length > 0;
  const hasTags = _env.default.TAGS.length > 0;
  const _iterable = document.tags;
  let _result = [];

  for (let _key = 0, _length = _iterable.length, _value; _key < _length; ++_key) {
    _value = _iterable[_key];
    _result[_key] = name;
  }

  const documentTags = _result;
  const documentHasTags = documentTags.length > 0 && (0, _some.default)(documentTags).call(documentTags, _tags2.matchesTags);
  const shouldSkipFeature = (0, _includes.default)(documentTags).call(documentTags, '@skip');
  let _result2 = false;

  for (let _key2 = 0, _length2 = specs.length, _value2; _key2 < _length2; ++_key2) {
    var _context2;

    _value2 = specs[_key2];

    if (_value2.scenario.tags.length && (0, _some.default)(_context2 = _value2.scenario.tags).call(_context2, ({
      name
    }) => (0, _tags2.matchesTags)(name))) {
      _result2 = true;
      break;
    }
  }

  const documentContainsSpecsWithTags = _result2;
  const scenarioTags = (0, _reduce.default)(specs).call(specs, (acc, spec) => {
    var _context3, _context4;

    return (0, _concat.default)(_context3 = []).call(_context3, (0, _toConsumableArray2.default)(acc), (0, _toConsumableArray2.default)((0, _map.default)(_context4 = spec.scenario.tags).call(_context4, ({
      name
    }) => name)));
  }, []);
  const documentHasDebugTag = (0, _includes.default)(scenarioTags).call(scenarioTags, '@debug');
  let _result3 = [];

  for (let _key3 = 0, _length3 = specs.length, _value3; _key3 < _length3; ++_key3) {
    var _context5, _context6, _context7;

    _value3 = specs[_key3];

    const _tags = (0, _map.default)(_context5 = _value3.scenario.tags).call(_context5, ({
      name: _name
    }) => _name);

    const _examples = (0, _table.parseExampleTable)(_value3.scenario.examples);

    const _shouldSkipForDebug = documentHasDebugTag && !(0, _includes.default)(_tags).call(_tags, '@debug');

    const _skip = _shouldSkipForDebug || (0, _includes.default)(_tags).call(_tags, '@skip') || hasTags && !_tags.length && !(0, _some.default)(_tags).call(_tags, _tags2.matchesTags);

    _result3 = (0, _concat.default)(_context6 = []).call(_context6, (0, _toConsumableArray2.default)(_result3), (0, _toConsumableArray2.default)(_examples.length ? (0, _map.default)(_context7 = (0, _table.generateExampleTableSteps)(_examples, _value3.scenario)).call(_context7, spec => _objectSpread(_objectSpread({}, spec), {}, {
      skip: _skip
    })) : [_objectSpread(_objectSpread({}, _value3.scenario), {}, {
      skip: _skip,
      steps: _value3.scenario.steps
    })]));
  }

  const scenarios = _result3;
  const skipFeature = shouldSkipFeature || hasTags && !documentHasTags && !documentContainsSpecsWithTags && !hasExcludeTags || scenarios.length === 0;
  let _result4 = [];

  for (let _key4 = 0, _length4 = scenarios.length, _value4; _key4 < _length4; ++_key4) {
    var _context8;

    _value4 = scenarios[_key4];
    _result4[_key4] = _objectSpread(_objectSpread({}, _value4), {}, {
      path: featurePath,
      steps: (0, _concat.default)(_context8 = []).call(_context8, (0, _toConsumableArray2.default)(hasBackground ? document.children[0].background.steps : []), (0, _toConsumableArray2.default)(_value4.steps))
    });
  }

  const suites = _result4;
  let _result5 = [];

  for (let _key5 = 0, _length5 = suites.length, _value5; _key5 < _length5; ++_key5) {
    _value5 = suites[_key5];
    _result5[_key5] = _objectSpread(_objectSpread({}, _value5), {}, {
      steps: (0, _steps.parseSteps)(_value5.steps, cucumberSupportCode.stepDefinitions)
    });
  }

  return {
    document,
    afterEach: cucumberSupportCode.afterTestCaseHookDefinitions,
    afterAll: cucumberSupportCode.afterTestRunHookDefinitions,
    beforeEach: cucumberSupportCode.beforeTestCaseHookDefinitions,
    beforeAll: cucumberSupportCode.beforeTestRunHookDefinitions,
    skip: skipFeature,
    suites: _result5
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9wYXJzZXJzL3N1aXRlLnRzIl0sIm5hbWVzIjpbInBhcnNlU3VpdGUiLCJjd2QiLCJmZWF0dXJlIiwiZXh0ZW5zaW9ucyIsImN1Y3VtYmVyU3VwcG9ydENvZGUiLCJmZWF0dXJlUGF0aCIsInNvdXJjZSIsImZzIiwicmVhZEZpbGVTeW5jIiwiZXZlbnRzIiwicGF0aCIsIm5vcm1hbGl6ZSIsInJlbGF0aXZlIiwiaW5jbHVkZVNvdXJjZSIsImluY2x1ZGVHaGVya2luRG9jdW1lbnQiLCJpbmNsdWRlUGlja2xlcyIsIm5ld0lkIiwiZ2hlcmtpbkRvY3VtZW50IiwiYXR0YWNobWVudCIsIkVycm9yIiwiY2hhbGsiLCJyZWQiLCJ5ZWxsb3ciLCJ0ZXh0IiwibG9jYXRpb24iLCJjb2x1bW4iLCJsaW5lIiwiam9pbiIsImRvY3VtZW50IiwiaGFzQmFja2dyb3VuZCIsImNoaWxkcmVuIiwiYmFja2dyb3VuZCIsInNwZWNzIiwiaGFzRXhjbHVkZVRhZ3MiLCJlbnYiLCJFWENMVURFX1RBR1MiLCJsZW5ndGgiLCJoYXNUYWdzIiwiVEFHUyIsInRhZ3MiLCJuYW1lIiwiZG9jdW1lbnRUYWdzIiwiZG9jdW1lbnRIYXNUYWdzIiwibWF0Y2hlc1RhZ3MiLCJzaG91bGRTa2lwRmVhdHVyZSIsInNwZWMiLCJzY2VuYXJpbyIsImRvY3VtZW50Q29udGFpbnNTcGVjc1dpdGhUYWdzIiwic2NlbmFyaW9UYWdzIiwiYWNjIiwiZG9jdW1lbnRIYXNEZWJ1Z1RhZyIsImV4YW1wbGVzIiwic2hvdWxkU2tpcEZvckRlYnVnIiwic2tpcCIsInN0ZXBzIiwic2NlbmFyaW9zIiwic2tpcEZlYXR1cmUiLCJzdWl0ZXMiLCJzdWl0ZSIsInN0ZXBEZWZpbml0aW9ucyIsImFmdGVyRWFjaCIsImFmdGVyVGVzdENhc2VIb29rRGVmaW5pdGlvbnMiLCJhZnRlckFsbCIsImFmdGVyVGVzdFJ1bkhvb2tEZWZpbml0aW9ucyIsImJlZm9yZUVhY2giLCJiZWZvcmVUZXN0Q2FzZUhvb2tE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bUJBQW1CLENBQUN1RCxlQUE1QztBQS9IWDtBQUFBOztBQXNISixTQUFPO0FBQ0gvQixJQUFBQSxRQURHO0FBRUhnQyxJQUFBQSxTQUFTLEVBQUV4RCxtQkFBbUIsQ0FBQ3lELDRCQUY1QjtBQUdIQyxJQUFBQSxRQUFRLEVBQUUxRCxtQkFBbUIsQ0FBQzJELDJCQUgzQjtBQUlIQyxJQUFBQSxVQUFVLEVBQUU1RCxtQkFBbUIsQ0FBQzZELDZCQUo3QjtBQUtIQyxJQUFBQSxTQUFTLEVBQUU5RCxtQkFBbUIsQ0FBQytELDRCQUw1QjtBQU1IZCxJQUFBQSxJQUFJLEVBQUVHLFdBTkg7QUFPSEMsSUFBQUEsTUFBTTtBQVBILEdBQVA7QUFZSCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuaW1wb3J0IFRlc3RDYXNlSG9va0RlZmluaXRpb24gZnJvbSAnQGN1Y3VtYmVyL2N1Y3VtYmVyL2xpYi9tb2RlbHMvdGVzdF9zdGVwX2hvb2tfZGVmaW5pdGlvbic7XG5pbXBvcnQgZ2VuZXJhdGVNZXNzYWdlcyBmcm9tICdAY3VjdW1iZXIvZ2hlcmtpbi9kaXN0L3NyYy9zdHJlYW0vZ2VuZXJhdGVNZXNzYWdlcyc7XG5pbXBvcnQge21lc3NhZ2VzfSBmcm9tICdAY3VjdW1iZXIvbWVzc2FnZXMnO1xuaW1wb3J0IHt1dWlkfSBmcm9tICdAY3VjdW1iZXIvbWVzc2FnZXMvZGlzdC9zcmMvSWRHZW5lcmF0b3InO1xuaW1wb3J0IGNoYWxrIGZyb20gJ2NoYWxrJztcbmltcG9ydCB7bWFwLCByZWR1Y2UsIHNvbWV9IGZyb20gJ2lubGluZS1sb29wcy5tYWNybyc7XG5pbXBvcnQgb3V0ZGVudCBmcm9tICdvdXRkZW50JztcblxuaW1wb3J0IGVudiBmcm9tICcuLi9jb25maWdzL2Vudic7XG5pbXBvcnQge3BhcnNlRmVhdHVyZX0gZnJvbSAnLi9mZWF0dXJlJztcbmltcG9ydCB7cGFyc2VTdGVwc30gZnJvbSAnLi9zdGVwcyc7XG5pbXBvcnQge2dlbmVyYXRlRXhhbXBsZVRhYmxlU3RlcHMsIHBhcnNlRXhhbXBsZVRhYmxlfSBmcm9tICcuL3RhYmxlJztcbmltcG9ydCB7bWF0Y2hlc1RhZ3N9IGZyb20gJy4vdGFncyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3BlYyB7XG4gICAgZG9jdW1lbnQ6IG1lc3NhZ2VzLkdoZXJraW5Eb2N1bWVudC5JRmVhdHVyZTtcbiAgICBhZnRlckVhY2g6IFRlc3RDYXNlSG9va0RlZmluaXRpb25bXTtcbiAgICBhZnRlckFsbDogVGVzdENhc2VIb29rRGVmaW5pdGlvbltdO1xuICAgIGJlZm9yZUVhY2g6IFRlc3RDYXNlSG9va0RlZmluaXRpb25bXTtcbiAgICBiZWZvcmVBbGw6IFRlc3RDYXNlSG9va0RlZmluaXRpb25bXTtcbiAgICBza2lwOiBCb29sZWFuO1xuICAgIHN1aXRlczogYW55O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFyc2VTdWl0ZShcbiAgICBjd2QsXG4gICAgZmVhdHVyZTogc3RyaW5nLFxuICAgIGV4dGVuc2lvbnM6IHN0cmluZ1tdLFxuICAgIGN1Y3VtYmVyU3VwcG9ydENvZGU6IGFueVxuKTogU3BlYyB7XG4gICAgY29uc3QgZmVhdHVyZVBhdGggPSBwYXJzZUZlYXR1cmUoY3dkLCBmZWF0dXJlLCBleHRlbnNpb25zKTtcblxuICAgIGNvbnN0IHNvdXJjZSA9IGZzLnJlYWRGaWxlU3luYyhmZWF0dXJlUGF0aCwgJ3V0ZjgnKTtcblxuICAgIGNvbnN0IGV2ZW50cyA9IGdlbmVyYXRlTWVzc2FnZXMoXG4gICAgICAgIHNvdXJjZSxcbiAgICAgICAgcGF0aC5ub3JtYWxpemUocGF0aC5yZWxhdGl2ZShjd2QsIGZlYXR1cmVQYXRoKSksXG4gICAgICAgIHtcbiAgICAgICAgICAgIGluY2x1ZGVTb3VyY2U6IGZhbHNlLFxuICAgICAgICAgICAgaW5jbHVkZUdoZXJraW5Eb2N1bWVudDogdHJ1ZSxcbiAgICAgICAgICAgIGluY2x1ZGVQaWNrbGVzOiB0cnVlLFxuICAgICAgICAgICAgbmV3SWQ6IHV1aWQoKVxuICAgICAgICB9XG4gICAgKTtcblxuICAgIGlmICghZXZlbnRzWzBdPy5naGVya2luRG9jdW1lbnQ/LmZlYXR1cmUpIHtcbiAgICAgICAgLy8gZmVhdHVyZSBpcyBub3QgZGVmaW5lZCBpZiBhbiBlcnJvciBvY2N1cnMgd2hpbGUgcGFyc2luZ1xuICAgICAgICAvLyBhbmQgdGhlIGVycm9yIGlzIGFkZGVkIGFzIGFuIGF0dGFjaG1lbnRcbiAgICAgICAgY29uc3QgYXR0YWNobWVudCA9IGV2ZW50c1swXT8uYXR0YWNobWVudDtcblxuICAgICAgICB0aHJvdyBuZXcgRXJyb3Iob3V0ZGVudGBcbiAgICAgICAgICAgICR7Y2hhbGsucmVkKCdbZXJyb3JdJyl9IGZhaWxlZCB0byBwYXJzZSBmZWF0dXJlIGZpbGU6XFxuXG4gICAgICAgICAgICBmaWxlOiAke2NoYWxrLnllbGxvdyhmZWF0dXJlUGF0aCl9XG4gICAgICAgICAgICAke1xuICAgICAgICAgICAgICAgIGF0dGFjaG1lbnRcbiAgICAgICAgICAgICAgICAgICAgPyBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGBtZXNzYWdlOiAke2F0dGFjaG1lbnQudGV4dH1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBgY29sdW1uOiAke2F0dGFjaG1lbnQuc291cmNlLmxvY2F0aW9uLmNvbHVtbn1gLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBgbGluZTogJHthdHRhY2htZW50LnNvdXJjZS5sb2NhdGlvbi5saW5lfWBcbiAgICAgICAgICAgICAgICAgICAgICBdLmpvaW4oJ1xcbicpXG4gICAgICAgICAgICAgICAgICAgIDogJydcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxcblxuICAgICAgICBgKTtcbiAgICB9XG5cbiAgICBjb25zdCBkb2N1bWVudCA9IGV2ZW50c1swXS5naGVya2luRG9jdW1lbnQuZmVhdHVyZTtcbiAgICBjb25zdCBoYXNCYWNrZ3JvdW5kID0gISFkb2N1bWVudC5jaGlsZHJlblswXS5iYWNrZ3JvdW5kO1xuICAgIGNvbnN0IHNwZWNzID0gaGFzQmFja2dyb3VuZFxuICAgICAgICA/IGRvY3VtZW50LmNoaWxkcmVuLnNsaWNlKDEpXG4gICAgICAgIDogZG9jdW1lbnQuY2hpbGRyZW47XG5cbiAgICBjb25zdCBoYXNFeGNsdWRlVGFncyA9IGVudi5FWENMVURFX1RBR1MubGVuZ3RoID4gMDtcbiAgICBjb25zdCBoYXNUYWdzID0gZW52LlRBR1MubGVuZ3RoID4gMDtcblxuICAgIGNvbnN0IGRvY3VtZW50VGFncyA9IG1hcChkb2N1bWVudC50YWdzLCAoe25hbWV9KSA9PiBuYW1lKTtcbiAgICBjb25zdCBkb2N1bWVudEhhc1RhZ3MgPVxuICAgICAgICBkb2N1bWVudFRhZ3MubGVuZ3RoID4gMCAmJiBkb2N1bWVudFRhZ3Muc29tZShtYXRjaGVzVGFncyk7XG4gICAgY29uc3Qgc2hvdWxkU2tpcEZlYXR1cmUgPSBkb2N1bWVudFRhZ3MuaW5jbHVkZXMoJ0Bza2lwJyk7XG5cbiAgICBjb25zdCBkb2N1bWVudENvbnRhaW5zU3BlY3NXaXRoVGFncyA9IHNvbWUoXG4gICAgICAgIHNwZWNzLFxuICAgICAgICAoc3BlYykgPT5cbiAgICAgICAgICAgIHNwZWMuc2NlbmFyaW8udGFncy5sZW5ndGggJiZcbiAgICAgICAgICAgIHNwZWMuc2NlbmFyaW8udGFncy5zb21lKCh7bmFtZX0pID0+IG1hdGNoZXNUYWdzKG5hbWUpKVxuICAgICk7XG5cbiAgICBjb25zdCBzY2VuYXJpb1RhZ3MgPSBzcGVjcy5yZWR1Y2UoXG4gICAgICAgIChhY2MsIHNwZWMpID0+IFsuLi5hY2MsIC4uLnNwZWMuc2NlbmFyaW8udGFncy5tYXAoKHtuYW1lfSkgPT4gbmFtZSldLFxuICAgICAgICBbXVxuICAgICk7XG5cbiAgICBjb25zdCBkb2N1bWVudEhhc0RlYnVnVGFnID0gc2NlbmFyaW9UYWdzLmluY2x1ZGVzKCdAZGVidWcnKTtcblxuICAgIGNvbnN0IHNjZW5hcmlvcyA9IHJlZHVjZShcbiAgICAgICAgc3BlY3MsXG4gICAgICAgIChhY2MsIHNwZWMpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IHRhZ3MgPSBzcGVjLnNjZW5hcmlvLnRhZ3MubWFwKCh7bmFtZX0pID0+IG5hbWUpO1xuXG4gICAgICAgICAgICBjb25zdCBleGFtcGxlcyA9IHBhcnNlRXhhbXBsZVRhYmxlKHNwZWMuc2NlbmFyaW8uZXhhbXBsZXMpO1xuXG4gICAgICAgICAgICBjb25zdCBzaG91bGRTa2lwRm9yRGVidWcgPVxuICAgICAgICAgICAgICAgIGRvY3VtZW50SGFzRGVidWdUYWcgJiYgIXRhZ3MuaW5jbHVkZXMoJ0BkZWJ1ZycpO1xuXG4gICAgICAgICAgICBjb25zdCBza2lwID1cbiAgICAgICAgICAgICAgICBzaG91bGRTa2lwRm9yRGVidWcgfHxcbiAgICAgICAgICAgICAgICB0YWdzLmluY2x1ZGVzKCdAc2tpcCcpIHx8XG4gICAgICAgICAgICAgICAgKGhhc1RhZ3MgJiYgIXRhZ3MubGVuZ3RoICYmICF0YWdzLnNvbWUobWF0Y2hlc1RhZ3MpKTtcblxuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICAuLi5hY2MsXG4gICAgICAgICAgICAgICAgLi4uKGV4YW1wbGVzLmxlbmd0aFxuICAgICAgICAgICAgICAgICAgICA/IGdlbmVyYXRlRXhhbXBsZVRhYmxlU3RlcHMoZXhhbXBsZXMsIHNwZWMuc2NlbmFyaW8pLm1hcChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKHNwZWMpID0+ICh7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5zcGVjLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2tpcFxuICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgOiBbXG4gICAgICAgICAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnNwZWMuc2NlbmFyaW8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICBza2lwLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RlcHM6IHNwZWMuc2NlbmFyaW8uc3RlcHNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgIF0pXG4gICAgICAgICAgICBdO1xuICAgICAgICB9LFxuICAgICAgICBbXVxuICAgICk7XG5cbiAgICBjb25zdCBza2lwRmVhdHVyZSA9XG4gICAgICAgIHNob3VsZFNraXBGZWF0dXJlIHx8XG4gICAgICAgIChoYXNUYWdzICYmXG4gICAgICAgICAgICAhZG9jdW1lbnRIYXNUYWdzICYmXG4gICAgICAgICAgICAhZG9jdW1lbnRDb250YWluc1NwZWNzV2l0aFRhZ3MgJiZcbiAgICAgICAgICAgICFoYXNFeGNsdWRlVGFncykgfHxcbiAgICAgICAgc2NlbmFyaW9zLmxlbmd0aCA9PT0gMDtcblxuICAgIGNvbnN0IHN1aXRlcyA9IG1hcChzY2VuYXJpb3MsIChzY2VuYXJpbykgPT4gKHtcbiAgICAgICAgLi4uc2NlbmFyaW8sXG4gICAgICAgIHBhdGg6IGZlYXR1cmVQYXRoLFxuICAgICAgICBzdGVwczogW1xuICAgICAgICAgICAgLi4uKGhhc0JhY2tncm91bmQgPyBkb2N1bWVudC5jaGlsZHJlblswXS5iYWNrZ3JvdW5kLnN0ZXBzIDogW10pLFxuICAgICAgICAgICAgLi4uc2NlbmFyaW8uc3RlcHNcbiAgICAgICAgXVxuICAgIH0pKTtcblxuICAgIHJldHVybiB7XG4gICAgICAgIGRvY3VtZW50LFxuICAgICAgICBhZnRlckVhY2g6IGN1Y3VtYmVyU3VwcG9ydENvZGUuYWZ0ZXJUZXN0Q2FzZUhvb2tEZWZpbml0aW9ucyxcbiAgICAgICAgYWZ0ZXJBbGw6IGN1Y3VtYmVyU3VwcG9ydENvZGUuYWZ0ZXJUZXN0UnVuSG9va0RlZmluaXRpb25zLFxuICAgICAgICBiZWZvcmVFYWNoOiBjdWN1bWJlclN1cHBvcnRDb2RlLmJlZm9yZVRlc3RDYXNlSG9va0RlZmluaXRpb25zLFxuICAgICAgICBiZWZvcmVBbGw6IGN1Y3VtYmVyU3VwcG9ydENvZGUuYmVmb3JlVGVzdFJ1bkhvb2tEZWZpbml0aW9ucyxcbiAgICAgICAgc2tpcDogc2tpcEZlYXR1cmUsXG4gICAgICAgIHN1aXRlczogbWFwKHN1aXRlcywgKHN1aXRlKSA9PiAoe1xuICAgICAgICAgICAgLi4uc3VpdGUsXG4gICAgICAgICAgICBzdGVwczogcGFyc2VTdGVwcyhzdWl0ZS5zdGVwcywgY3VjdW1iZXJTdXBwb3J0Q29kZS5zdGVwRGVmaW5pdGlvbnMpXG4gICAgICAgIH0pKVxuICAgIH07XG59XG4iXX0=